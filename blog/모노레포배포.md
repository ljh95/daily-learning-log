토스는 하나의 모노레포에서 관리하는 서비스가 200개가 넘고
매일 50~60 기여자가 코드를 추가함
레포지토리 크기는 40GB가 넘음
git clone명령어로는 복제도차 불가능해 filter=blob:none 옵션을 해야함ㄴ함
그럼에도 5분만 걸림,

## 1. 병렬화, 그러나 독립된 환경에서 실행

모노레포는 한 번의 PR이 여러 서비스에 영향을 ㅁ칠 수 있음
3개의 서비스가 변경되었다면 9번의 빌드를 실행해야함

단순히 빌드를 병렬로 실행하느것만으로 충분하지 않은
하나의 머신에서 여러 빌드를 동시에 실행한면 한정된 CPU와 메모리 자원을 나눠쓰게 되어 속도가 느려질 수있음
토스의 ㅎ결책은 각 빌드 파이프라인을 환전히 독립되 ㄴ가사머신에서 실행하느넛
Circle CI의 Dynamic Configuration 같은 기능을 활용하며 변경되 서비슷 개수만큼 독립적인 비르 빌드 파일프라인ㅇ을 동적으로 생성할 수 있음
각 파이프라인은 자신만의 ㅇ노전한 컴퓨팅 리소스를 할당받앗 리행됨

효과는 그적임
2개의 서비슷르 배포하던, 40개 혹은 200개를 배포하든 전체 리들 시간은 약 6분 내외로 거의 동일하게 유지됨
이 시간은 1분의 트리거 파이프라인 실행시간과 5분의 병렬 파이프라인실행시간을 합한 결과
2개 서비스 변경 기준 기존 30분 걸리던 작업이 6분으로 줄어, 약 5배 속도 개선을 이뤄냄

각 파이프라인을 독립된 컴퓨팅 환경에서 수행하는것이 ㄱ가장 중요함

## 2. 36분까지git checkout을 22초로 줄임

CI파이프라인의 숨은 복병중 하나는 소스 코들르 내려받는 git checkout시간임
토스의 모노레포는 40GB가 넘기에 CI러너가 매번 처음부퍼이 레포질토리를 클론하면 36분이라는 엄청난 시간이 걸리면 타임아웃 오류가 발생하기도 함

토스의 우하한 해결책은 매일 아치 ㅁ모노레포를 미리 복제해두는것
매인 오전 7시에 스케줄링 된 잡이 최신 법전의 모노레포코드르 포함한 도커 벵이스 이미지를 자동으로 만들ㅇ둠
이때 Dockerfile에서는 먼저 --depth50으로 얕게 ㅌ클론하여 빠르게 코드를 받은 뒤
depth 1000으로 ㅅ히스토리를 추가로 fetch하는 전략으 사용해 효율적으로 이미지르 생성함
CI작업이 ㅅ시작면 CircleCi의 executoryts같은 ㅣ능을 통해 이 미리 준비되 이미지 기반으로 실행됩니다.
그 후에는 아침에 이미지가 만들어진 시점부터 현재까지의 아주 자은 변경분만 fetch하면 됨

이 기법을 ㄴ통해 36분이 단 22초로 줄었음
이는 파이프라인의 모든 단일 작업마다 거의 36분의 시간을 절약하느 엄천난 효과였음

## 비결3: 배포 이미지 크기를 1/20로 줄이는 Standalone 전략

서버 사이드 렌더링 ㄹ애플링케이션의 배포 속도는 도커 이미지 크기에 크게 좌우됨
이미지가 클수록 쿠버네티스 환경에서 이미지ㅏ를 내려받고 파드르 새ㅣㄹ행하는데 오랜 시간이 걸기기 때문ㅇ
Next.js는 Node File Trace 기술을 기반으로 한 output: "standalone"이라는 유용한 기능제공
이 기능은 런타임에 필요한 최소한의 파일만 추적해서
결과물에 폿함시겨 이미지 크기를 획기적으로 줄여줌
하지만 한가지 문제강 있음
이 기능으 ㄴnode_modules 디렌토리 구조에 의존하는데 토스는 의존성 관리에 Yarn PNP를 사요하고있었음

그래서ㅗ 토스틑 Yarn PnP API를 활용해 NBext.js의 standalone기능과 동일한 역하을 하는 함술흘 직접 구현함
이 함수느 애플ㄹ리케이션 실행에 꼴 필요한 런타임 의존성 파일들만 정홧히 추적하여 하나의 bundle.zip파일로 압축함
최종 배포용 Dockerfile은 이bundle.zip파일 하나만 복사해서 압추을 푼뒤 바로 서버를 실행하느 아주 단순한 구조를 가짐

이 커스텀 standalone 전략읠 결과는 놀라움
SSR 배포용 도커 이미지 크기아 4GB에서 약 200MB로 20배나 줄음
이미지 크기가 작아지자 쿠버네티스의 PodIniiializing(K8S pod를 띄울 필요한 도커 이미지르 ㄹpull하느 과정)시간이 극적으로 단추됨

## 결론: 스케일은 속도의 적이 아니다.

- 병렬화를 통한 CI/CD 속도 최적화 -> 배포시간 5배 개선
- Daily Docker BAse Image -> Job당 36분 개선
- SSR Standalone Docker Image -> Pod뜨는 시간 20배 개선
